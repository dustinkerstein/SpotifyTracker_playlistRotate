<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Spotity Playlist Rotate</title>
  <style>
			body {
				background: #1ed760;
				color: white;
				font-size: 1.25rem;
			}

			body,
			html {
				margin: 0;
				padding: 0;
			}
	</style>
	<script>	
    google.script.url.getLocation(function(location) {
      const auth_code = location.parameter.code;
      google.script.run
      .withSuccessHandler((e) => {
        console.log("getData success");
        if (auth_code) {
          if ('localStorage' in window && 'fetch' in window) {
            var xhr = new XMLHttpRequest();
            var data = "grant_type=authorization_code&code=" + auth_code + "&redirect_uri=" + encodeURI(e.execURL + "?callback");
            xhr.addEventListener("readystatechange", function () {
              if (this.readyState == XMLHttpRequest.DONE && this.status === 200) {
                let res = JSON.parse(this.response)
                if (res.access_token) {
                  access_token = res.access_token
                  localStorage.setItem("access_token", access_token);
                  localStorage.setItem("refresh_token", res.refresh_token);
                  localStorage.setItem("token_expiration", "" + new Date(+new Date() + 0 + (+res.expires_in) * 1000))
                  window.open(e.execURL,'_top');
                } else {
                  writeError();
                }
              }
            });
            xhr.open("POST", "https://accounts.spotify.com/api/token");
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.setRequestHeader("Authorization", "Basic " + btoa(e.clientID + ':' + e.clientSecret))
            xhr.send(data);
          } else {
            writeError();
          }
        } else {
          writeError();
        }
      })
      .withFailureHandler((e) => {
        console.log("getData failure:", e);
      })
      .getData();
    });

    function writeError() {
			document.write("Something went wrong. <a href='../SpotifyTracker/'>Go home</a>");
    }
	</script>
</head>
<body>
</body>
</html>