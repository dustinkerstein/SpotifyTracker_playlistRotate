<!DOCTYPE html>
<html lang="en">
	<head>
		<base target="_top">
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Spotity Playlist Rotate</title>
		<style>
			body {
				background: #1ed760;
				color: white;
				font-size: 1.25rem;
			}

			body,
			html {
				margin: 0;
				padding: 0;
			}

			#loggedIn:not(.shown),
			#notLoggedIn:not(.shown),
			#expired:not(.shown),
			#playback:not(.shown),
			#lastPlayer:not(.shown) {
				display: none;
			}

			#loading.hidden {
				display: none;
			}

			* {
				font-family: Roboto, Arial, Helvetica, sans-serif;
			}
			
			.container {
				padding: 24px;
				margin: 16px 0;
        border-radius: 12px;
			}

			.shaded-container {
				background-color: rgba(0, 0, 0, .1);
        cursor: pointer;
        transition-duration: 400ms;
        box-shadow: #00000000 4px 4px 10px;
			}

			button {
				outline: none;
				border: none;
				background: rgba(0, 0, 0, .15);
				color: white;
				border-radius: 6px;
				padding: 12px;
				font-weight: bold;
				letter-spacing: 2px;
				margin: 6px;
				font-size: 1.15rem;
				font-family: Roboto, Arial, Helvetica, sans-serif;
				text-transform: uppercase;
				cursor: pointer;
			}

      button:hover {
        background: rgba(0, 0, 0, .28);
        box-shadow: #00000044 4px 4px 10px;
      }
		</style>
		<script>
      google.script.run
      .withSuccessHandler((e) => {
        console.log("getData success");
        var access_token;
        var player = {};
        var isPaused = false;
        var hasAlerted = false;
        var isLoggingOff = false;
        var searchQuery;
        var availableDevice;
        var playerUpdate;
        var auth_url = "https://accounts.spotify.com/authorize?client_id=" + e.clientID + "&redirect_uri=" + encodeURI(e.execURL + "?callback") + "&scope=user-read-private%20user-read-email%20user-modify-playback-state%20user-read-playback-state%20user-top-read%20user-read-recently-played&response_type=code";
        var currentSongID;
        var previousSongID;
        var uniqueSongCounter = 0;
        var playlistIndex;
        var isRotationEnabled = false;
        var nextTrigger = false;

        initialize();

        async function initialize() {
          playlistIndex = Math.floor(Math.random() * e.playlistIDs.length);
          console.log("Starting random playlistIndex: " + playlistIndex);
          if (!('localStorage' in window)) {
            document.write("<p>Sorry, the page is designed only for modern browsers.</p>");
          } else {
            if (localStorage.getItem('refresh_token')) {
              access_token = localStorage.getItem("access_token");
              document.getElementById("loggedIn").classList.add("shown");
              document.getElementById('signout').addEventListener('click', signOut);
              document.getElementById('loadFavourites').addEventListener('click', loadFavourites);
              document.getElementById('lastPlayer').addEventListener('click', newPlayback);
              document.getElementById('search').addEventListener('click', search);
              document.getElementById('pauseplay').addEventListener('click', function () {
                controlPlayback(player ? (player.is_playing ? 'pause' : 'play') : '');
              });
              document.getElementById('next').addEventListener('click', function () {
                nextTrigger = true;
                controlPlayback('next', 'POST');
              });
              document.getElementById('prev').addEventListener('click', function () {
                controlPlayback('previous', 'POST');
              });
              document.getElementById('rotation').addEventListener('click', function () {
                if (!isRotationEnabled) {
                  console.log("Enabling playlist rotation");
                  isRotationEnabled = true;
                  uniqueSongCounter = e.numberSongsToPlay;
                  nextTrigger = true;
                  rotatePlaylist();
                } else {
                  console.log("Disabling playlist rotation");
                  isRotationEnabled = false;
                  uniqueSongCounter = 0;
                }
              });
              updatePlayer();
              updateTimer();
              setInterval(updatePlayer, 1000);
              setInterval(updateTimer, 250);
              let result = await request("GET", 'me')
              document.getElementById("user").innerHTML = " as " + result.display_name + " (" + result.email + ")";
            } else {
              document.getElementById("newLogin").setAttribute("href", auth_url);
              document.getElementById("notLoggedIn").classList.add("shown");
              document.getElementById("loading").classList.add("hidden");
            }
          }
        } 

        function rotatePlaylist() {
          if (isRotationEnabled && ++uniqueSongCounter > e.numberSongsToPlay) {
            uniqueSongCounter = 0;
            playlistIndex = (playlistIndex + 1) % e.playlistIDs.length;
            playlistIndex = isNaN(parseFloat(playlistIndex)) ? 0 : playlistIndex;
            let uri = 'spotify:playlist:' + e.playlistIDs[playlistIndex];
            let data = { context_uri: uri, };
            console.log("ROTATING. playlistIndex: " + playlistIndex + " playlistID: " + e.playlistIDs[playlistIndex] + " uri: " + uri);
            controlPlayback('play', "PUT", '', data);
            return true;
          }
          return false;
        }

        async function request(method, path, data) {
          return new Promise(resolve => {
            (async () => {
              let xhr = new XMLHttpRequest();
              xhr.open(method, 'https://api.spotify.com/v1/' + path);
              xhr.onreadystatechange = function () {
                if (this.readyState == XMLHttpRequest.DONE) {
                  if (this.status === 200) {
                    resolve(JSON.parse(this.response))
                  } else {
                    if(this.response) {
                      resolve({ ...JSON.parse(this.response), ...{ status: this.status } })
                    } else {
                      resolve({ status: this.status })
                    }
                  }
                };
              }
              xhr.setRequestHeader('Authorization', 'Bearer ' + await getAccessToken())
              xhr.send(data ? JSON.stringify(data) : undefined);
            })()
          })
        }

        async function getAccessToken() {
          return new Promise(resolve => {
            let expiration = localStorage.getItem("token_expiration");
            if (expiration && (new Date(expiration) > new Date())) {
              // we don't need a new access token
              resolve(localStorage.getItem('access_token'))
            } else {
              var xhr = new XMLHttpRequest();
              var data = "grant_type=refresh_token&refresh_token=" + localStorage.getItem('refresh_token');
              xhr.addEventListener("readystatechange", function () {
                if (this.readyState == XMLHttpRequest.DONE && this.status === 200) {
                  let res = JSON.parse(this.response)
                  if (res.access_token) {
                    access_token = res.access_token
                    localStorage.setItem("access_token", access_token);
                    localStorage.setItem("token_expiration", "" + new Date(+new Date() + (+res.expires_in) * 1000));
                    resolve(access_token)
                  } else {
                    writeError();
                  }
                }
              });
              xhr.open("POST", "https://accounts.spotify.com/api/token");
              xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
              xhr.setRequestHeader("Authorization", "Basic " + btoa(e.clientID + ':' + e.clientSecret))
              xhr.send(data);
            }
          })
        }

        async function loadFavourites() {
          if (document.getElementById("loadFavourites").innerHTML != 'Load favorites list') {
            document.getElementById("artists").innerHTML = '';
            document.getElementById("tracks").innerHTML = '';
            document.getElementById("loadFavourites").innerHTML = 'Load favorites list';
            return;
          }

          let result_artists = await request('GET', 'me/top/artists?time_range=short_term')
          document.getElementById("artists").innerHTML = '';
          document.getElementById("tracks").innerHTML = '';
          if (!result_artists || !('items' in result_artists)) {
            document.getElementById("artists").innerHTML = '<b>Something went wrong.</b>';
          } else {
            let items = result_artists.items;
            let html = '<h1>Most listened to artists (last 4 weeks)</h1>';
            for (let i = 0; i < items.length; i++) {
              const el = items[i];
              html += '<li>' + el.name + '</li>'
            }
            document.getElementById("artists").innerHTML = html;
            document.getElementById("loadFavourites").innerHTML = 'Clear favorites list';
          }

          let result_tracks = await request('GET', 'me/top/tracks?time_range=short_term')
          if (!result_tracks || !('items' in result_tracks)) {
            alert("Something went wrong!");
          } else {
            let items = result_tracks.items;
            let html = '<h1>Most listened to artists (last 4 weeks)</h1>';
            for (let i = 0; i < items.length; i++) {
              const el = items[i];
              html += '<li>' + el.artists[0].name + " - " + el.name + '</li>'
            }
            document.getElementById("tracks").innerHTML = html;
          }
        }

        function signOut() {
          localStorage.removeItem('token_expiration');
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
          isLoggingOff = true;
          window.open(e.execURL,'_top');
        }

        async function controlPlayback(action, method, params, data) {
          let result = await request(method || 'PUT', 'me/player/' + action + (params || ""), data || {})
          if (result.status === 200) {
            if (updatePlayer) updatePlayer();
          } else if (result.status === 404) {
            if ((JSON.parse(this.response || {}).error || {}).reason == 'NO_ACTIVE_DEVICE') {
              alert('No device available!')
            }
          }
        }

        async function updatePlayer() {
          let result = await request("GET", "me/player")
          player.isPaused = false;
          let playerEl = document.getElementById("playerData");
          if (result.status && player.status !== 200) {
            playerEl.innerHTML = "<b>Nothing playing at the moment.</b>";
            document.getElementById("playback").classList.remove("shown");
            checkDevices();
          } else {
            if (!result) return;
            player = result;
            playerUpdate = +new Date();

            let html = "<b>Now playing:</b> ";
            if (player.item) {
              html += player.item.artists[0].name + " - " + player.item.name;
            }

            currentSongID =  player.item.id;
            if (nextTrigger) {
              nextTrigger = false;
              previousSongID = currentSongID;
              uniqueSongCounter = 0;
              console.log("nextTrigger detected");
            } else if (currentSongID != previousSongID) {
              console.log("New song detected");
              previousSongID = currentSongID;
              rotatePlaylist();
            }

            document.getElementById("pauseplay").innerHTML = player.is_playing ? "Pause" : "Play";
            playerEl.innerHTML = html;
            document.getElementById("rotation").innerHTML = isRotationEnabled ? 'Disable Playlist Rotation' : 'Enable Playlist Rotation';
            updateTimer();
            document.getElementById("playback").classList.add("shown");
            document.getElementById("lastPlayer").classList.remove("shown");
          }
        }

        async function checkDevices() {
          let result = await request("GET", "me/player/devices")
          availableDevice = null;
          if (result.devices.length > 0) {
            availableDevice = result.devices[0];
            document.getElementById("lastPlayer").classList.add("shown");
          } else {
            document.getElementById("lastPlayer").classList.remove("shown");
          }
        }

        function updateTimer() {
          let timer = document.getElementById('timer');
          let prependZero = function (n) {
            return n < 10 ? ('0' + n) : n;
          }
          let parseTime = function (t) {
            return prependZero(Math.floor(t / 60000)) + ":" + prependZero(Math.floor(t / 1000) % 60);
          }
          if (player.item) {
            let progress = player['progress_ms'];
            let duration = player.item['duration_ms'];
            if (player.is_playing) {
              let ts = playerUpdate;
              let diff = +new Date() - ts;
              progress += diff;
              if (progress > duration) {
                updatePlayer();
              }
            }
            timer.innerHTML = parseTime(progress) + '/' + parseTime(duration);
          } else {
            timer.innerHTML = '-/-';
          }
        }

        function newPlayback() {
          controlPlayback('', "PUT", '', {
            device_ids: [availableDevice.id],
            play: true
          });
        }

        function search() {
          document.getElementById("searchResults").innerHTML = '';
          setTimeout(async function () {
            searchQuery = '';
            searchQuery = prompt("Zoekopdracht");
            if (!searchQuery || !searchQuery.length) return;
            let result = await request('GET', 'search?type=track,album,artist&market=nl&q=' + searchQuery)
            let albums = result.albums.items;
            let artists = result.artists.items;
            let tracks = result.tracks.items;

            let html = '<br><b>Searched for: </b>' + searchQuery + '<br><button id="clearSearch">Clear search</button><br><br><br>';

            if (artists.length) {
              html += '<b>Found Artists</b><ul>';
              for (let i = 0; i < artists.length && i < 3; i++) {
                html += '<li>' + artists[i].name + "&nbsp;&nbsp;&nbsp;<button class='playURI' URI=" + artists[i].uri + ">Play</button></li>";
              }
              html += '</ul>';
            }

            if (tracks.length) {
              html += '<b>Found Songs</b><ul>';
              for (let i = 0; i < tracks.length && i < 12; i++) {
                html += '<li>' + tracks[i].artists[0].name + " - " + tracks[i].name + "&nbsp;&nbsp;&nbsp;<button class='playURI' URI=" + tracks[i].uri + ">Play</button></li>";
              }
              html += '</ul>';
            }

            if (albums.length) {
              html += '<b>Found Albums</b><ul>';
              for (let i = 0; i < albums.length && i < 3; i++) {
                html += '<li>' + albums[i].artists[0].name + " - " + albums[i].name + "&nbsp;&nbsp;&nbsp;<button class='playURI' URI=" + albums[i].uri + ">Play</button></li>";
              }
              html += '</ul>';
            }

            document.getElementById("searchResults").innerHTML = html;
            document.getElementById("clearSearch").addEventListener("click", function () {
              document.getElementById("searchResults").innerHTML = '';
            });

            let btns = document.getElementsByClassName("playURI");
            for (let i = 0; i < btns.length; i++) {
              const btn = btns[i];
              btn.addEventListener('click', function () {
                let uri = this.attributes.uri.value;

                let data = uri.startsWith("spotify:track") ? { uris: [uri], } : { context_uri: uri, };
                controlPlayback('play', "PUT", '', data);
              })
            }
          }, 50);
        }
      })
      .withFailureHandler((e) => {
        console.log("getData failure:", e);
      })
      .getData();
		</script>
	</head>
	<body>
		<p id='loading'></p>
		<div id="notLoggedIn">
			<div class="container">
				<p>Welcome! <a id='newLogin'>Login via Spotify</a></p>
			</div>
		</div>
		<div id="expired">
			<div class="container">
				<p>Session expired! <a id='expiredLogin'>Login again</a></p>
			</div>
		</div>
		<div id="loggedIn">
			<div class="container">
				<p>Logged in<span id='user'></span></p>
				<button id='signout'>Log out</button>
				<div class="container shaded-container">
					<p id="playerData"></p>
					<div id="playback">
						<p id="timer"></p>
						<button id='prev'>Prev</button>
						<button id='pauseplay'>Play</button>
						<button id='next'>Next</button>
						<button id='rotation'>Set rotation on/off</button>
					</div>
					<button id='lastPlayer'>Continue playing</button>
				</div>
				<div class="container shaded-container">
					<button id='loadFavourites'>Load favorites list</button>
					<ol id='artists'></ol>
					<br>
					<ol id='tracks'></ol>
				</div>
        <div class="container shaded-container">
					<button id='search'>Search</button>
					<br>
					<div id="searchResults"></div>
				</div>
			</div>
		</div>
	</body>
</html>